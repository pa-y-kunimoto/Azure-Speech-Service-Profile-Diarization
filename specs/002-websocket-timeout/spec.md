# Feature Specification: WebSocket セッションタイムアウト設定

**Feature Branch**: `002-websocket-timeout`  
**Created**: 2025年12月5日  
**Status**: Draft  
**Input**: User description: "長時間ウェブソケットに接続しっぱなしだと、Azure Speech Service の従量課金の値段が高くつくので、タイムアウト時間を設定できるようにしたいです。デフォルト15分とかに設定できますでしょうか？"

## 概要

Azure Speech Service は従量課金制であり、WebSocket接続が長時間維持されると不要なコストが発生する。本機能は、セッションのタイムアウト時間を設定可能にし、一定時間経過後に自動的に接続を終了することでコストを抑制する。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自動タイムアウトによるコスト保護 (Priority: P1)

ユーザーがリアルタイム音声認識セッションを開始した後、席を離れたり、ブラウザタブを開いたまま他の作業を行ったりすることがある。この場合、設定されたタイムアウト時間（デフォルト15分）が経過すると、システムが自動的にセッションを終了し、不要なAzure Speech Serviceの従量課金を防止する。

**Why this priority**: コスト削減が本機能の主目的であり、自動タイムアウトなしでは機能の価値がない。

**Independent Test**: タイムアウト時間を短く設定し、その時間経過後にセッションが自動終了することを確認できる。

**Acceptance Scenarios**:

1. **Given** ユーザーがデフォルト設定（15分）でセッションを開始している、**When** 15分間音声認識が実行され続ける、**Then** システムがセッションを自動終了し、ユーザーに終了通知を表示する
2. **Given** セッションがアクティブ状態である、**When** タイムアウトまで残り1分になる、**Then** ユーザーに警告通知を表示し、延長するかどうかを選択させる
3. **Given** タイムアウト警告が表示されている、**When** ユーザーが延長を選択する、**Then** タイムアウトタイマーがリセットされ、セッションが継続される

---

### User Story 2 - サービス提供者によるタイムアウト時間の設定 (Priority: P2)

サービス提供者（管理者）は、環境変数を通じてタイムアウト時間を設定し、コスト管理を行いたい。ユーザーごとの設定変更を許可せず、サービス全体で統一されたタイムアウトポリシーを適用することで、予期せぬコスト超過を防止する。

**Why this priority**: デフォルト値があれば最低限の機能は動作するが、サービス提供者がビジネス要件に応じて柔軟に調整できることで運用価値が向上する。

**Independent Test**: 環境変数でタイムアウト時間を変更し、その値でセッションがタイムアウトすることを確認できる。

**Acceptance Scenarios**:

1. **Given** サービス提供者が環境変数でタイムアウト時間を30分に設定している、**When** ユーザーがセッションを開始する、**Then** セッションは30分後に自動終了する
2. **Given** サービス提供者が環境変数でタイムアウトを無効（0）に設定している、**When** ユーザーがセッションを開始する、**Then** セッションは自動終了せず、手動終了のみ可能となる
3. **Given** 環境変数が設定されていない、**When** サービスが起動する、**Then** デフォルト値（15分）が適用される

---

### User Story 3 - 残り時間の可視化 (Priority: P3)

ユーザーはセッション中に残り時間を常に把握し、計画的に利用したい。画面上に残り時間が表示されることで、急な終了を避け、必要に応じて延長の判断ができる。

**Why this priority**: 基本機能は残り時間表示なしでも動作するが、ユーザー体験と利便性を大幅に向上させる。

**Independent Test**: セッション中に残り時間表示が更新され続けることを確認できる。

**Acceptance Scenarios**:

1. **Given** セッションがアクティブ状態である、**When** 時間が経過する、**Then** 画面上の残り時間表示がリアルタイムで更新される
2. **Given** 残り時間が5分未満になった、**When** ユーザーが画面を見る、**Then** 残り時間が視覚的に強調表示される（色の変更など）

---

### User Story 4 - 無音検出による自動セッション終了 (Priority: P2)

ユーザーがマイクをオンにしたまま席を離れたり、会議が終了したことを忘れてセッションを放置したりすることがある。一定時間（デフォルト5分）発話が検出されない場合、システムが自動的にセッションを終了し、Azure Speech Serviceの不要な課金を防止する。これは通常のセッションタイムアウトとは独立した追加の安全弁として機能する。

**Why this priority**: コスト削減の主目的に直結し、通常タイムアウトを待たずに早期にセッションを終了できるため、P1に次ぐ重要度。

**Independent Test**: 無音状態を5分間継続し、セッションが自動終了することを確認できる。

**Acceptance Scenarios**:

1. **Given** セッションがアクティブ状態である、**When** 5分間発話が検出されない、**Then** システムがセッションを自動終了し、ユーザーに「無音のためセッションを終了しました」と通知する
2. **Given** 無音状態が4分間続いている、**When** ユーザーが発話する、**Then** 無音タイマーがリセットされ、セッションは継続する
3. **Given** 通常タイムアウトが15分、無音タイムアウトが5分に設定されている、**When** セッション開始後3分間発話し、その後5分間無音、**Then** 8分時点（無音5分経過）でセッションが終了する（通常タイムアウトの15分より早い）
4. **Given** 無音状態が4分間続いている、**When** 無音タイムアウトまで残り1分になる、**Then** ユーザーに警告通知を表示する（発話すれば自動的にタイマーがリセットされる）

---

### Edge Cases

- タイムアウト警告表示中にネットワーク切断が発生した場合：サーバー側でタイムアウト処理を実行し、再接続時に終了状態を通知する
- ブラウザがバックグラウンドになった場合：サーバー側でタイマーを管理するため、クライアントの状態に依存しない
- 複数タブで同一セッションにアクセスした場合：サーバー側の単一タイマーで管理し、全タブに同期された状態を送信する
- タイムアウト時間を0または負の値に設定しようとした場合：最小値（1分）を適用し、ユーザーに通知する
- セッションが一時停止（pause）状態の場合：一時停止中もタイマーは継続する（コスト発生の可能性があるため）
- 無音検出タイムアウトと通常タイムアウトが同時に発生した場合：先に条件を満たした方で終了処理を実行
- 環境ノイズのみで発話がない場合：音声認識結果（transcription）の有無で判定し、ノイズは発話とみなさない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは環境変数を通じてタイムアウト時間を設定できる機能を提供しなければならない
- **FR-002**: タイムアウト時間のデフォルト値は15分でなければならない
- **FR-003**: 環境変数で設定可能なタイムアウト時間の範囲は1分〜120分でなければならない
- **FR-004**: 環境変数でタイムアウトを無効化（無制限）に設定できなければならない
- **FR-005**: システムはタイムアウト1分前にユーザーに警告通知を送信しなければならない
- **FR-006**: ユーザーは警告通知からセッションを延長できなければならない
- **FR-007**: 延長時、タイマーは設定されたタイムアウト時間分リセットされなければならない
- **FR-008**: タイムアウト発生時、システムはWebSocket接続とAzure Speech Serviceへの接続を適切に終了しなければならない
- **FR-009**: システムはセッション中に残り時間を表示しなければならない
- **FR-010**: サーバー側でタイマーを管理し、クライアントの状態に依存しない設計としなければならない
- **FR-011**: システムは環境変数を通じて無音タイムアウト時間を設定できなければならない
- **FR-012**: 無音タイムアウト時間のデフォルト値は5分でなければならない
- **FR-013**: 発話が検出されるたびに無音タイマーをリセットしなければならない
- **FR-014**: 無音タイムアウトと通常タイムアウトは独立して動作し、どちらか早い方でセッションを終了しなければならない
- **FR-015**: 無音タイムアウト1分前にユーザーに警告通知を送信しなければならない
- **FR-016**: 無音タイムアウトでセッション終了時、ユーザーに終了理由を通知しなければならない

### Key Entities

- **SessionTimeout**: セッションのタイムアウト設定を表す。タイムアウト時間（分）、有効/無効フラグ、残り時間を含む
- **TimeoutWarning**: タイムアウト警告の状態を表す。警告表示中フラグ、残り時間を含む
- **SilenceTimeout**: 無音タイムアウト設定を表す。無音タイムアウト時間（分）、最終発話検出時刻、残り時間を含む

## Clarifications

### Session 2025-12-05

- Q: ユーザーによるタイムアウト時間変更の可否 → A: サービス提供者が環境変数でタイムアウト時間を固定し、ユーザーは変更不可（延長機能のみ利用可能）
- Q: ユーザー延長回数の制限 → A: 延長回数に制限なし
- Q: タイムアウト無効化の値 → A: 環境変数に `0` を設定するとタイムアウト無効（無制限）
- Q: 一時停止中のタイマー動作 → A: 一時停止中もタイマーは継続する（コスト発生の可能性があるため）
- Q: タイムアウト警告のタイミング → A: 固定で1分前に警告
- Q: 無音検出タイムアウトと通常タイムアウトの関係 → A: 両方のタイマーを独立して動作させ、どちらか早い方でセッション終了
- Q: 無音検出タイムアウト前の警告 → A: 無音タイムアウトにも1分前警告を表示し、ユーザーに継続確認を求める
- Q: 無音タイムアウト警告からの延長動作 → A: ユーザーが発話すると自動的に無音タイマーがリセットされるため、明示的な「継続」操作は不要

## Assumptions

- タイムアウト時間の単位は「分」とする（ユーザーにとって分かりやすく、典型的な会議時間単位と一致）
- 一時停止（pause）中もタイマーは継続する（サーバーリソース・Azure接続は維持されている可能性があるため）
- 延長は1回につき元のタイムアウト時間分追加される（例: 15分設定なら15分延長）
- 延長回数に制限は設けない
- タイムアウト時間はサービス提供者が環境変数で設定し、エンドユーザーは変更できない

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 設定したタイムアウト時間の±10秒以内の精度でセッションが自動終了する
- **SC-002**: タイムアウト警告はセッション終了の1分前（±5秒）に表示される
- **SC-003**: ユーザーが延長操作を行った場合、3秒以内にタイマーがリセットされる
- **SC-004**: 残り時間表示は1秒単位で更新される
- **SC-005**: タイムアウト機能導入後、平均セッション時間が20%以上短縮される（意図しない長時間接続の削減）
- **SC-006**: 90%以上のユーザーがタイムアウト警告を確認し、意図的に終了または延長を選択できる
